# Copilot Instructions

- **Project Snapshot**: Spring Boot 3.4 + LangChain4j (OpenAI-compatible Wenxin models) with MCP clients for Notion and PaddleOCR; SQLite persistence; API served under context path `/api` on port 3001. Reference [README.md](README.md) and [pom.xml](pom.xml) for tooling.
- **Request Flow**: `/api/analyze` accepts multipart `image` and/or `message` plus optional `profile`/`learnerId`, then [AnalyzeService](src/main/java/com/learning/agent/service/AnalyzeService.java) builds `AgentState` and runs [AgentWorkflow](src/main/java/com/learning/agent/workflow/AgentWorkflow.java): OCR → planning → execution.
- **Analyze defaults**: uploads are saved to `uploads/`; learner profile falls back to defaults and will reuse the Notion parent page ID as `learnerId` if none is supplied; parent page chosen by searching "Learning Dashboard" then any page via `NotionClient`.
- **OCR Node**: [WorkflowNodes.createOcrNode](src/main/java/com/learning/agent/workflow/WorkflowNodes.java) calls `PaddleOcrClient.runStructuredOcr`; skips when no image path; failures throw after storing an `OcrStructuredResult`.
- **Planning Node**: [WorkflowNodes.createPlanningNode](src/main/java/com/learning/agent/workflow/WorkflowNodes.java) sends the `PLANNING_SYSTEM_PROMPT` and a constructed input containing learner info, user query, and OCR plain/markdown text; expects a raw JSON array (no code fences) of tasks; blank/invalid output is treated as an error.
- **Execution Modes**: toggled by `agent.execution.use-react-mode` / `USE_REACT_MODE` (default true per [application.properties](src/main/resources/application.properties)). `true` → ReAct path; `false` → standard function-calling with LangChain4j tools.
- **ReAct Path**: [ReactExecutor](src/main/java/com/learning/agent/workflow/ReactExecutor.java) uses `executionChatModel` with a fixed system prompt requiring Thought/Action and a single JSON tool call per turn; runs up to 5 iterations and accumulates created Notion pages from observations. Preserve the JSON-block parsing and final-answer detection when modifying.
- **Function-Calling Path**: [WorkflowNodes.createExecutionNode](src/main/java/com/learning/agent/workflow/WorkflowNodes.java) builds a prompt that mandates `notionSearch` for "sophie" to obtain `parentPageId` before `notionCreatePage`, disallows simulated JSON, and requires real tool calls. The LangChain4j `NotionExecutor` uses tools from `NotionToolService`; outputs are scanned for page IDs/URLs to surface in the response.
- **Available Tools**: [ToolFunctionsConfig.NotionToolService](src/main/java/com/learning/agent/config/client/ToolFunctionsConfig.java) exposes `notionSearch`, `notionCreatePage`, `notionAppendContent`, `notionGetSelf`, `notionSearchAll`, `notionRetrievePage` to the execution model; [NotionTools](src/main/java/com/learning/agent/client/NotionTools.java) performs the actual MCP-backed calls.
- **Model Config**: [LangChain4jConfig](src/main/java/com/learning/agent/config/client/LangChain4jConfig.java) builds two `OpenAiChatModel` instances (planning: low temp, execution: higher temp) pointed at Wenxin base URL and model name from env (`WENXIN_API_KEY`, `WENXIN_BASE_URL`, `WENXIN_MODEL`). Requests/responses are logged; timeouts 120–180s.
- **Endpoints**: Controller is mounted at `/` but the servlet context path makes public routes `/api/analyze` (POST multipart) and `/api/health` (GET). Missing both image and message returns 400.
- **Data & storage**: SQLite file at `data/learning_agent.db` initialized from [schema.sql](src/main/resources/schema.sql); file uploads in `uploads/`; logs under `logs/`.
- **Config env**: Key properties in [application.properties](src/main/resources/application.properties) mirror `.env.example`: Wenxin creds, Notion MCP token/version, PaddleOCR MCP server/timeouts, `MCP_CONFIG_PATH`, multipart upload limits (10MB), logging levels.
- **Build/Run**: `mvn spring-boot:run` for dev; `mvn clean package` then `java -jar target/learning-agent-1.0.0-SNAPSHOT.jar` to run the built artifact. API health check at `/api/health`.
- **Tests**: `mvn test` for all; scope with `-Dtest=ClassName`. Integration and workflow tests live under `src/test/java/com/learning/agent`.
- **MCP Setup**: Notion MCP via `npx @notionhq/notion-mcp-server`; PaddleOCR MCP via conda env + `paddleocr_mcp`; configuration resolved from `mcp-config.jsonc` or overridden by `MCP_CONFIG_PATH`.
- **Extension tips**: When adding new MCP tools, wire client logic in `NotionTools` (or new client class), register via `NotionToolService`, and ensure execution prompts and page-link extraction in `WorkflowNodes` handle new outputs. When altering planning/execution prompts, keep mandatory Notion search/create steps intact.
